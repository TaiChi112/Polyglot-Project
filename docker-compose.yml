services:
  # ==========================================
  # üóÑÔ∏è DATABASE SERVICE (PostgreSQL)
  # ==========================================
  postgres-db:
    image: postgres:15-alpine
    container_name: polyglot_postgres
    restart: always
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    ports:
      - "${DB_PORT}:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./database:/docker-entrypoint-initdb.d

    # üö® HEALTHCHECK: ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Database ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö Query ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ==========================================
  # ‚öôÔ∏è BACKEND SERVICES
  # ==========================================
  backend-fiber:
    build: 
      context: ./backend-fiber
    container_name: service_fiber
    env_file:
      - .env
    ports:
      - "${PORT_FIBER}:4001"
    # üö® DEPENDS_ON: ‡∏£‡∏≠‡πÉ‡∏´‡πâ Database "Healthy" ‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≠‡∏¢‡∏£‡∏±‡∏ô Service ‡∏ô‡∏µ‡πâ
    depends_on:
      postgres-db:
        condition: service_healthy

  backend-actix:
    build: 
      context: ./backend-actix
    container_name: service_actix
    env_file:
      - .env
    ports:
      - "${PORT_ACTIX}:4003"
    depends_on:
      postgres-db:
        condition: service_healthy

  backend-fastapi:
    build: 
      context: ./backend-fastapi
    container_name: service_fastapi
    env_file:
      - .env
    ports:
      - "${PORT_FASTAPI}:4002"
    depends_on:
      postgres-db:
        condition: service_healthy
    
  backend-elysia:
    build: 
      context: ./backend-elysia
    container_name: service_elysia
    env_file:
      - .env
    ports:
      - "${PORT_ELYSIA}:4000"
    depends_on:
      postgres-db:
        condition: service_healthy

  # (‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° backend-fastapi ‡πÅ‡∏•‡∏∞ backend-elysia ‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö)

  # ==========================================
  # üåê FRONTEND SERVICE
  # ==========================================
  frontend-nextjs:
    build: 
      context: ./frontend-nextjs
    container_name: service_nextjs
    env_file:
      - .env
    ports:
      - "${PORT_FRONTEND}:3000"
    # Frontend ‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ API Gateway (Elysia) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡πà‡∏≠‡∏ô
    depends_on:
      - backend-elysia

volumes:
  pgdata: # ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® Volume ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Database ‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î Container